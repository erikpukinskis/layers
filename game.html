<html>

<head>
<title>Learning WebGL &mdash; lesson 4</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="http://www.senchalabs.org/philogl/PhiloGL/build/PhiloGL.js"></script>
<script>
  var cube = new PhiloGL.O3D.Model({
    vertices: [0, 0,  1,
                1, 0,  1,
                1,  1,  1,
               0,  1,  1,

               0, 0, 0,
               0,  1, 0,
                1,  1, 0,
                1, 0, 0,

               0,  1, 0,
               0,  1,  1,
                1,  1,  1,
                1,  1, 0,

               0, 0, 0,
                1, 0, 0,
                1, 0,  1,
               0, 0,  1,

                1, 0, 0,
                1,  1, 0,
                1,  1,  1,
                1, 0,  1,

               0, 0, 0,
               0, 0,  1,
               0,  1,  1,
               0,  1, 0],

    colors: [1, 1, 1, 1, 
             1, 1, 1, 1,
             1, 1, 1, 1,
             1, 1, 1, 1,

             1, 1, 0, 1, 
             1, 1, 0, 1, 
             1, 1, 0, 1, 
             1, 1, 0, 1, 

             0, 1, 0, 1, 
             0, 1, 0, 1, 
             0, 1, 0, 1, 
             0, 1, 0, 1, 

             1, 0.5, 0.5, 1, 
             1, 0.5, 0.5, 1, 
             1, 0.5, 0.5, 1, 
             1, 0.5, 0.5, 1, 

             1, 0, 1, 1, 
             1, 0, 1, 1, 
             1, 0, 1, 1, 
             1, 0, 1, 1, 
             
             0, 0, 1, 1,
             0, 0, 1, 1,
             0, 0, 1, 1,
             0, 0, 1, 1],

    indices: [0, 1, 2, 0, 2, 3,
              4, 5, 6, 4, 6, 7,
              8, 9, 10, 8, 10, 11,
              12, 13, 14, 12, 14, 15,
              16, 17, 18, 16, 18, 19,
              20, 21, 22, 20, 22, 23]
  });

  cube.position.set(1.5, 0, -8);


  function webGLStart() {
      PhiloGL('lesson04-canvas', {
          program: {
              from: 'ids',
              vs: 'shader-vs',
              fs: 'shader-fs'
          },
          onError: function () {
              alert("An error ocurred while loading the application");
          },
          onLoad: function (app) {
              var gl = app.gl,
                  canvas = app.canvas,
                  program = app.program,
                  camera = app.camera,
                  view = new PhiloGL.Mat4,
                  rCube = 0;

              gl.viewport(0, 0, canvas.width, canvas.height);
              gl.clearColor(0, 0, 0, 1);
              gl.clearDepth(1);
              gl.enable(gl.DEPTH_TEST);
              gl.depthFunc(gl.LEQUAL);

              camera.view.id();

              function setupElement(elem) {
                  //update element matrix
                  elem.update();
                  //get new view matrix out of element and camera matrices
                  view.mulMat42(camera.view, elem.matrix);
                  //set buffers with element data
                  program.setBuffers({
                      'aVertexPosition': {
                          value: elem.vertices,
                          size: 3
                      },
                      'aVertexColor': {
                          value: elem.colors,
                          size: 4
                      }
                  });
                  //set uniforms
                  program.setUniform('uMVMatrix', view);
                  program.setUniform('uPMatrix', camera.projection);
              }

              function animate() {}

              function tick() {
                  drawScene();
                  animate();
                  PhiloGL.Fx.requestAnimationFrame(tick);
              }

              function drawScene() {
                  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                  //Draw Cube
                  cube.rotation.set(rCube, rCube, rCube);
                  setupElement(cube);
                  program.setBuffer('indices', {
                      value: cube.indices,
                      bufferType: gl.ELEMENT_ARRAY_BUFFER,
                      size: 1
                  });
                  gl.drawElements(gl.TRIANGLES, cube.indices.length, gl.UNSIGNED_SHORT, 0);
              }

              tick();
          }
      });

  }


    document.onkeydown = function (e) {
        k = {
            left: 37,
            up: 38,
            right: 39,
            down: 40,
        }
        var offset = {x:0, y:0, z:0};
        switch(e.keyCode) {
            case k.up: offset.y = 1; break;
            case k.right: offset.x = 1; break;
            case k.down: offset.y = -1; break;
            case k.left: offset.x = -1; break;
        }

        cube.position.x += offset.x;
        cube.position.y += offset.y;
        cube.position.z += offset.z;
    }
</script>

<script id="shader-fs" type="x-shader/x-fragment">
  #ifdef GL_ES
  precision highp float;
  #endif

  varying vec4 vColor;

  void main(void) {
    gl_FragColor = vColor;
  }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
  attribute vec3 aVertexPosition;
  attribute vec4 aVertexColor;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  varying vec4 vColor;

  void main(void) {
    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    vColor = aVertexColor;
  }

</script>
</head>

<body onload="webGLStart();" id="body">
  <canvas id="lesson04-canvas" style="border: none;" width="500" height="500"></canvas>
</body>
</html>

