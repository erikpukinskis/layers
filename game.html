<html>

<head>
<title>Learning WebGL &mdash; lesson 4</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script src="http://www.senchalabs.org/philogl/PhiloGL/build/PhiloGL.js"></script>
<script src="underscore.js"></script>
<script src="palette.js"></script>

<script>
function uni(r,g,b) {
    var side = function(r,g,b,off) {
    if (typeof off == 'undefined') { off = 0 }
    r -= off;
    g -= off;
    b -= off;
    return [r,g,b,1,
            r,g,b,1,
            r,g,b,1,
            r,g,b,1];
  }

    return [].concat(
        side(r,g,b,0.1), //front
        side(r,g,b,0.1), //back
        side(r,g,b,0.05), //top
        side(r,g,b,0.05), //bottom
        side(r,g,b,0.2), //right
        side(r,g,b) //left
    );
};


cubeAttrs = {
vertices: [0, 0,  1,
            1, 0,  1,
            1,  1,  1,
           0,  1,  1,

           0, 0, 0,
           0,  1, 0,
            1,  1, 0,
            1, 0, 0,

           0,  1, 0,
           0,  1,  1,
            1,  1,  1,
            1,  1, 0,

           0, 0, 0,
            1, 0, 0,
            1, 0,  1,
           0, 0,  1,

            1, 0, 0,
            1,  1, 0,
            1,  1,  1,
            1, 0,  1,

           0, 0, 0,
           0, 0,  1,
           0,  1,  1,
           0,  1, 0],

colors: uni(1,1,1),

indices: [0, 1, 2, 0, 2, 3,
          4, 5, 6, 4, 6, 7,
          8, 9, 10, 8, 10, 11,
          12, 13, 14, 12, 14, 15,
          16, 17, 18, 16, 18, 19,
          20, 21, 22, 20, 22, 23]
};


var Box = function() { PhiloGL.O3D.Model.call(this, cubeAttrs); }

Box.prototype = Object.create(PhiloGL.O3D.Model.prototype, {

})

Math.identity = function(val) { return val }

var World = function() {
    this.objects = [];

    this.neighbor = function(position, direction) {
        _world = this;
        return _.reduce(this.objects, function(best, object) {
            if (object == _world.selected) { return best }
            if (!best) { return object }
            var dx = Math.identity(object.position.x - position.x);
            var dy = Math.abs(object.position.y - position.y);

            if ((dx > 0) && (dx <= dy)) {
                object.score = dx + dy;
                return (object.score > best.score) ? object : best;
            } else {
                return best;
            }
        }, null);
    }
}

var world = new World();
world.objects.push(new Box(), new Box());
world.selected = world.objects[0];

var selected = 0;
var highlight = 0;
var highlightIncrement = 0.003;

function colorCube() {
    if ((highlight > 0.05) || (highlight < -0.05)) {
        highlightIncrement *= -1;
    }
    highlight += highlightIncrement;
    var c = hslToRgb(hsl(color[0],color[1]));

    world.selected.colors = uni(
        c[0]/255+highlight, 
        c[1]/255+highlight, 
        c[2]/255+highlight
    );
}

function webGLStart() {
    PhiloGL('lesson04-canvas', {
      program: {
          from: 'ids',
          vs: 'shader-vs',
          fs: 'shader-fs'
      },
      onError: function () {
          alert("An error ocurred while loading the application");
      },
      onLoad: function (app) {
          var gl = app.gl,
              canvas = app.canvas,
              program = app.program,
              camera = app.camera,
              view = new PhiloGL.Mat4,
              rCube = 0;

          gl.viewport(0, 0, canvas.width, canvas.height);
          gl.clearColor(0, 0, 0, 1);
          gl.clearDepth(1);
          gl.enable(gl.DEPTH_TEST);
          gl.depthFunc(gl.LEQUAL);

          camera.view.id();

          world.objects[0].position.set(1, 0, -8);
          world.objects[1].position.set(0, 0, -8);

          function setupElement(elem) {
              //update element matrix
              elem.update();
              //get new view matrix out of element and camera matrices
              view.mulMat42(camera.view, elem.matrix);
              //set buffers with element data
              program.setBuffers({
                  'aVertexPosition': {
                      value: elem.vertices,
                      size: 3
                  },
                  'aVertexColor': {
                      value: elem.colors,
                      size: 4
                  },
              });
              //set uniforms
              program.setUniform('uMVMatrix', view);
              program.setUniform('uPMatrix', camera.projection);

          }

          function tick() {
              drawScene();
              PhiloGL.Fx.requestAnimationFrame(tick);
          }

            function drawScene() {
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                //Draw Cube
                for(var i=0; i<2; i++) {
                    setupElement(world.objects[i]);

                    colorCube();

                    program.setBuffer('indices', {
                        value: world.objects[i].indices,
                        bufferType: gl.ELEMENT_ARRAY_BUFFER,
                        size: 1
                    });

                    gl.drawElements(gl.TRIANGLES, world.objects[i].indices.length, gl.UNSIGNED_SHORT, 0);
                }
            }

          tick();
      }
    });

}

</script>

<script id="shader-fs" type="x-shader/x-fragment">
  #ifdef GL_ES
  precision highp float;
  #endif

  varying vec4 vColor;

  void main(void) {
    gl_FragColor = vColor;
  }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
  attribute vec3 aVertexPosition;
  attribute vec4 aVertexColor;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  varying vec4 vColor;

  void main(void) {
    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    vColor = aVertexColor;
  }

</script>

<link rel="stylesheet" href="style.css" />

</head>

<body onload="webGLStart();" id="body">
  <div id="message"></div>
  <canvas id="lesson04-canvas" style="border: none;" width="500" height="500"></canvas>
</body>

<script>
    var mode = 'move';

    document.onkeydown = function (e) {
        if (e.keyCode == k[modes[mode].key]) {
            mode = modes[mode].next;
            setHelp();
        }

        newMode = _.find(modes, function(attr,name) {
            if(k[attr.key] == e.keyCode) {
                return mode = name;
            }
        })

        if (newMode) { return setHelp() }

        if (f = modes[mode].onkeydown) { 
            f(e, arrowKeyDirection(e));
        }
    }

    k = {
        left: 37,
        up: 38,
        right: 39,
        down: 40,
        space: 32,
        m: 77,
        c: 67,
        s: 83,
        n: 78,
    }

    modes = {
        move: {
            help: 'use arrow keys to move',
            next: 'color',
            key: 'm',
            onkeydown: function(e, direction) {
                world.selected.position.x += direction.x;
                world.selected.position.y += direction.y;
                world.selected.position.z += direction.z;        
            },
        },
        color: {
            help: 'change colors with arrow keys',
            next: 'select',
            key: 'c',
            onkeydown: function(e, direction) {
                color[0] = bounded(color[0]+direction.x, 0, width);
                color[1] = bounded(color[1]+direction.y, 0, height);
            },
        },
        select: {
            help: 'select',
            next: 'move',
            key: 's',
            onkeydown: function(e, direction) {
                world.selected = world.neighbor(direction);
            }
        },
    };

    var modeKeys = _.map(modes, function(mode) { return k[mode.key] });

    function arrowKeyDirection(e) {
        var direction = {x:0, y:0, z:0};
        switch(e.keyCode) {
            case k.up: direction.y = 1; break;
            case k.right: direction.x = 1; break;
            case k.down: direction.y = -1; break;
            case k.left: direction.x = -1; break;
        }
        return direction;        
    }

    function bounded(val,min,max) {
        return Math.max(Math.min(val,max), min);
    }

    var color = [12,10];

    function setHelp() {
        document.getElementById('message').innerHTML = modes[mode].help;        
    }

    setHelp();

</script>
</html>

